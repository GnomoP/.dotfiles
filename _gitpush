#!/bin/bash

pull () {
  set -e
  set -u

  local ORG_PWD="$PWD"
  cd "$HOME/.dotfiles"

  eval "git add -A $*"

  set +e
  eval "git commit -m \"$(whoami)@$(hostname) $(date "+%F %T")\" $*"
  if [[ "$?" -eq 1 ]]; then
    echo "Last commit: $(git log -1 --pretty=%s)"
    return
  fi
  set -e

  eval "git push -u origin master $*"

  if [[ ! -d "_gitrepos" ]]; then
    mkdir "_gitrepos"
    cd "$ORG_PWD"
    return
  fi

  cd "_gitrepos"

  TIMESTAMP="$(GIT_WORK_TREE="../" git log -1 --pretty=%s)"
  [[ -d "$TIMESTAMP" ]] ||\
    eval "git clone git+ssh://git@github.com/GnomoP/.dotfiles-kali \"$TIMESTAMP\" $*"
  ln -sf "_gitrepos/$TIMESTAMP" "../_gitlast"

  # shellcheck disable=SC2010
  if [[ "$(find . -maxdepth 1 -type d | grep -cvx '^.$')" -gt 10 ]]; then
    local dir
    dir="$(find . -maxdepth 1 -type d | grep -vx '^.$' | sort | head -n 1)"

    echo "Directory count is greater than 10"
    echo "Removing '$dir' from _gitrepos"
    rm -rf "$dir"
  fi

  cd "$ORG_PWD"
}

[[ -z "$*" ]] &&
  pull && exit

while [[ -n "$*" ]]; do
  case "$1" in
    '-s' | '--silent')
      pull "/dev/null" "2>&1"
      exit
      ;;

    '-w' | '--write')
      [[ -z "$2" ]] &&\
        exit

      name="$(realpath "$0")"
      name="$(basename "$name")"

      faketty () { script -qfc "$(printf "%q " "$@")"; }

      faketty "$name" > "$2" &
      multitail -c "$2"

      # tail --pid="$!" -f "$2" | perl -pe \
      #  "s/($(whoami)@$(hostname) \d{4}-\d{2}\d{2}\d{2}:\d{2}:\{2})/\e[1;31m$&\e[0m/g"

      # shellcheck disable=SC2094
      # faketty cat "$2" | col -b > "$2"

      # shellcheck disable=SC2002
      # cat "$2" | col -xb > "$2.clean"

      unset -f faketty
      unset name
      ;;

    *)
      ;;
  esac
  shift
done
# vim: syntax=sh
# vim: set ts=2 sw=2 tw=80 et :
