#!/bin/bash

pull () {
  set -e
  set -u

  local ORG_PWD="$PWD"
  cd "$HOME/.dotfiles"

  git add -A
  git commit -m "$(whoami)@$(hostname) $(date "+%F %T")"
  git push -u origin master

  if [[ ! -d "_gitrepos" ]]; then
    mkdir "_gitrepos"
    cd "$ORG_PWD"
    return
  fi

  cd "_gitrepos"

  TIMESTAMP="$(GIT_WORK_TREE="../" git log -1 --pretty=%s)"
  [[ -d "$TIMESTAMP" ]] ||\
    git clone git+ssh://git@github.com/GnomoP/.dotfiles-kali "$TIMESTAMP"
  ln -sf "_gitrepos/$TIMESTAMP" "../_gitlast"

  # shellcheck disable=SC2010
  if [[ "$(find . -maxdepth 1 -type d | grep -cvx '^.$')" -gt 10 ]]; then
    local dir
    dir="$(find . -maxdepth 1 -type d | grep -vx '^.$' | sort | head -n 1)"

    echo "Removing '$dir' from _gitrepos: directory count is greater than 10"
  fi

  cd "$ORG_PWD"
}

if [[ -n "$1" ]]; then
  pull > /dev/null 2>&1
else
  pull
fi
